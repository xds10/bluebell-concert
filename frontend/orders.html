<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>我的订单</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .orders-container { 
            max-width: 800px; 
            margin: 40px auto; 
            background: #fff; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px #eee; 
            padding: 32px; 
        }
        .order-item { 
            border-bottom: 1px solid #eee; 
            padding: 16px 0; 
            display: flex; 
            justify-content: space-between;
            align-items: center;
        }
        .order-item:last-child { border-bottom: none; }
        .order-info { flex: 1; }
        .order-actions { 
            margin-left: 20px;
            display: flex;
            align-items: center;
        }
        .detail-btn {
            padding: 8px 16px;
            background-color: #3f51b5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .detail-btn:hover {
            background-color: #303f9f;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }
        .page-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            background-color: #f8f8f8;
            cursor: pointer;
            border-radius: 4px;
        }
        .page-btn.active {
            background-color: #3f51b5;
            color: white;
            border-color: #3f51b5;
        }
        .page-btn:hover:not(.active) {
            background-color: #e8e8e8;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo"><i class="fas fa-ticket-alt"></i>演唱会票务系统</div>
        <div class="nav-links">
            <a href="index.html">首页</a>
            <a href="index.html">演唱会列表</a>
            <a href="orders.html">我的订单</a>
            <div class="user-section">
                <a href="login.html" id="loginBtn">登录</a>
                <a href="register.html" id="registerBtn">注册</a>
                <a href="#" id="logoutBtn" style="display: none;">退出</a>
            </div>
        </div>
    </nav>
    <div class="orders-container">
        <h2>我的订单</h2>
        <div class="search-container">
            <input type="text" id="orderSearchInput" placeholder="搜索订单号或演唱会名称..." class="search-input">
        </div>
        <div id="ordersList">加载中...</div>
        <div id="pagination" class="pagination"></div>
    </div>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // 分页相关变量
        let currentPage = 1;
        const ordersPerPage = 10;
        let allOrders = [];
        let filteredOrders = [];
        
        async function loadOrders() {
            const ordersListDiv = document.getElementById('ordersList');
            const paginationDiv = document.getElementById('pagination');
            
            if (!auth.isAuthenticated) {
                ordersListDiv.innerHTML = '<div style="padding: 32px; text-align: center; color: #888; font-size: 20px;">请先登录</div>';
                paginationDiv.innerHTML = '';
                return;
            }
            
            try {
                // 获取用户信息
                const loginResult = JSON.parse(localStorage.getItem('loginResult'));
                // 使用orderAPI.getOrderList函数
                const response = await orderAPI.getOrderList(parseInt(loginResult.user_id));
                console.log('订单列表数据:', response.data); // 调试输出
                
                if (response.code === 1000 && response.data) {
                    if (response.data.length === 0) {
                        ordersListDiv.innerHTML = '<div style="padding: 32px; text-align: center; color: #888; font-size: 20px;">暂无订单</div>';
                        paginationDiv.innerHTML = '';
                        return;
                    }
                    
                    // 按创建时间排序，最新的在前面
                    allOrders = response.data.sort((a, b) => {
                        return new Date(b.create_time) - new Date(a.create_time);
                    });
                    
                    // 初始化过滤后的订单列表
                    filteredOrders = [...allOrders];
                    
                    // 显示当前页的订单
                    await displayOrdersPage(currentPage);
                    
                    // 设置分页
                    setupPagination();
                    
                    // 初始化搜索功能
                    initSearch();
                } else {
                    ordersListDiv.innerHTML = '<div style="padding: 32px; text-align: center; color: #888; font-size: 20px;">加载失败</div>';
                    paginationDiv.innerHTML = '';
                }
            } catch (error) {
                ordersListDiv.innerHTML = '<div style="padding: 32px; text-align: center; color: #888; font-size: 20px;">加载失败</div>';
                paginationDiv.innerHTML = '';
            }
        }
        
        function initSearch() {
            const searchInput = document.getElementById('orderSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', async () => {
                    const searchTerm = searchInput.value.trim().toLowerCase();
                    
                    // 过滤订单
                    filteredOrders = allOrders.filter(order => {
                        // 搜索订单号
                        if (order.id && order.id.toString().includes(searchTerm)) {
                            return true;
                        }
                        
                        // 搜索演唱会名称
                        if (order.concert_title && order.concert_title.toLowerCase().includes(searchTerm)) {
                            return true;
                        }
                        
                        return false;
                    });
                    
                    // 重置到第一页
                    currentPage = 1;
                    
                    // 更新显示
                    await displayOrdersPage(currentPage);
                    setupPagination();
                });
            }
        }
        
        async function displayOrdersPage(page) {
            const ordersListDiv = document.getElementById('ordersList');
            ordersListDiv.innerHTML = '';
            
            if (filteredOrders.length === 0) {
                ordersListDiv.innerHTML = '<div style="padding: 32px; text-align: center; color: #888; font-size: 20px;">没有找到匹配的订单</div>';
                return;
            }
            
            // 计算当前页应该显示的订单
            const startIndex = (page - 1) * ordersPerPage;
            const endIndex = Math.min(startIndex + ordersPerPage, filteredOrders.length);
            const currentPageOrders = filteredOrders.slice(startIndex, endIndex);
            
            // 创建一个映射来存储演唱会ID和标题
            const concertTitles = {};
            
            // 首先获取所有需要的演唱会信息
            const concertPromises = currentPageOrders
                .filter(order => order.concert_id && !concertTitles[order.concert_id])
                .map(async order => {
                    try {
                        const response = await concertAPI.getDetail(order.concert_id);
                        if (response.code === 1000 && response.data) {
                            concertTitles[order.concert_id] = response.data.title;
                        }
                    } catch (error) {
                        console.error(`获取演唱会信息失败，ID: ${order.concert_id}`, error);
                    }
                });
            
            // 等待所有演唱会信息获取完成
            await Promise.all(concertPromises);
            
            currentPageOrders.forEach(order => {
                // 获取座位信息
                let seatInfo = '未知';
                if (order.ticket && order.ticket.seat_idx) {
                    const seat = order.ticket.seat_idx;
                    seatInfo = `${seat.section || '未知区域'}`;
                    if (seat.seat_row) seatInfo += ` ${seat.seat_row}排`;
                    if (seat.seat_no) seatInfo += ` ${seat.seat_no}号`;
                } else {
                    // 如果订单没有座位信息，尝试从订单详情获取
                    (async function() {
                        try {
                            const orderDetail = await orderAPI.getOrderDetail(order.id);
                            if (orderDetail.code === 1000 && orderDetail.data && 
                                orderDetail.data.ticket && orderDetail.data.ticket.seat_idx) {
                                const seat = orderDetail.data.ticket.seat_idx;
                                const seatText = `${seat.section || '未知区域'} ${seat.seat_row || ''}排 ${seat.seat_no || ''}号`;
                                
                                // 找到当前订单对应的DOM元素并更新座位信息
                                const orderElements = document.querySelectorAll(`.order-item`);
                                orderElements.forEach(elem => {
                                    const idElem = elem.querySelector('b');
                                    if (idElem && idElem.textContent === `订单号：${order.id}`) {
                                        const seatElem = elem.querySelector('div:nth-child(3)');
                                        if (seatElem) {
                                            seatElem.textContent = `座位：${seatText}`;
                                        }
                                    }
                                });
                            }
                        } catch (error) {
                            console.error(`获取订单详情失败，ID: ${order.id}`, error);
                        }
                    })();
                }
                
                // 获取演唱会标题
                const concertTitle = order.concert_id ? (concertTitles[order.concert_id] || '加载中...') : '未知';
                
                const orderDiv = document.createElement('div');
                orderDiv.className = 'order-item';
                orderDiv.innerHTML = `
                    <div class="order-info">
                        <div><b>订单号：${order.id}</b></div>
                        <div>演唱会：${concertTitle}</div>
                        <div>座位：${seatInfo}</div>
                        <div>价格：${order.price || '未知'}</div>
                        <div>状态：${getOrderStatusText(order.status)}</div>
                        <div>创建时间：${new Date(order.create_time).toLocaleString()}</div>
                    </div>
                    <div class="order-actions">
                        <button class="detail-btn" onclick="window.location.href='order_detail.html?order_id=${order.id}'">查看详情</button>
                    </div>
                `;
                ordersListDiv.appendChild(orderDiv);
            });
        }
        
        function setupPagination() {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';
            
            const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
            
            // 如果只有一页，不显示分页
            if (totalPages <= 1) {
                return;
            }
            
            // 添加上一页按钮
            if (currentPage > 1) {
                const prevBtn = document.createElement('div');
                prevBtn.className = 'page-btn';
                prevBtn.textContent = '上一页';
                prevBtn.addEventListener('click', async () => {
                    currentPage--;
                    await displayOrdersPage(currentPage);
                    setupPagination();
                });
                paginationDiv.appendChild(prevBtn);
            }
            
            // 添加页码按钮
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('div');
                pageBtn.className = 'page-btn';
                if (i === currentPage) {
                    pageBtn.classList.add('active');
                }
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', async () => {
                    currentPage = i;
                    await displayOrdersPage(currentPage);
                    setupPagination();
                });
                paginationDiv.appendChild(pageBtn);
            }
            
            // 添加下一页按钮
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('div');
                nextBtn.className = 'page-btn';
                nextBtn.textContent = '下一页';
                nextBtn.addEventListener('click', async () => {
                    currentPage++;
                    await displayOrdersPage(currentPage);
                    setupPagination();
                });
                paginationDiv.appendChild(nextBtn);
            }
        }

        // 获取订单状态文本
        function getOrderStatusText(status) {
            switch (status) {
                case 1: return "未支付";
                case 2: return "已支付";
                case 3: return "已过期";
                case 4: return "已取消";
                default: return "未知状态";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            auth.init();
            loadOrders();
        });
    </script>
</body>
</html> 