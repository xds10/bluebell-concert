<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>我的订单</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #1976d2; color: white; }
        .logo { font-size: 20px; font-weight: bold; }
        .nav-links { display: flex; gap: 20px; }
        .nav-links a { color: white; text-decoration: none; }
        .orders-container { max-width: 800px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #eee; padding: 32px; }
        .order-item { border-bottom: 1px solid #eee; padding: 16px 0; }
        .order-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">演唱会票务系统</div>
        <div class="nav-links">
            <a href="index.html">首页</a>
            <a href="index.html">演唱会列表</a>
            <a href="orders.html">我的订单</a>
            <div class="user-section">
                <a href="#" id="loginBtn">登录</a>
                <a href="#" id="registerBtn">注册</a>
                <a href="#" id="logoutBtn" style="display: none;">退出</a>
            </div>
        </div>
    </nav>
    <div class="orders-container">
        <h2>我的订单</h2>
        <div id="ordersList">加载中...</div>
    </div>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        async function loadOrders() {
            const ordersListDiv = document.getElementById('ordersList');
            if (!auth.isAuthenticated) {
                ordersListDiv.innerHTML = '<div style="padding: 32px; text-align: center; color: #888; font-size: 20px;">请先登录</div>';
                return;
            }
            try {
                // 获取用户信息
                const loginResult = JSON.parse(localStorage.getItem('loginResult'));
                // 使用orderAPI.getOrderList函数
                const response = await orderAPI.getOrderList(parseInt(loginResult.user_id));
                console.log('订单列表数据:', response.data); // 调试输出
                if (response.code === 1000 && response.data) {
                    if (response.data.length === 0) {
                        ordersListDiv.innerHTML = '<div style="padding: 32px; text-align: center; color: #888; font-size: 20px;">暂无订单</div>';
                        return;
                    }
                    ordersListDiv.innerHTML = '';
                    response.data.forEach(order => {
                        // 获取座位信息
                        let seatInfo = '未知';
                        if (order.ticket && order.ticket.seat_idx) {
                            const seat = order.ticket.seat_idx;
                            seatInfo = `${seat.section || '未知区域'}`;
                            if (seat.seat_row) seatInfo += ` ${seat.seat_row}排`;
                            if (seat.seat_no) seatInfo += ` ${seat.seat_no}号`;
                        } else if (order.seat_section) {
                            // 兼容旧数据结构
                            seatInfo = order.seat_section;
                        }
                        
                        const orderDiv = document.createElement('div');
                        orderDiv.className = 'order-item';
                        orderDiv.innerHTML = `
                            <div><b>订单号：${order.id}</b></div>
                            <div>演唱会：${order.concert_title || '未知'}</div>
                            <div>座位：${seatInfo}</div>
                            <div>价格：${order.price || '未知'}</div>
                            <div>状态：${getOrderStatusText(order.status)}</div>
                            <div>创建时间：${new Date(order.create_time).toLocaleString()}</div>
                            <button onclick="window.location.href='order_detail.html?order_id=${order.id}'">查看详情</button>
                        `;
                        ordersListDiv.appendChild(orderDiv);
                    });
                } else {
                    ordersListDiv.innerHTML = '<div style="padding: 32px; text-align: center; color: #888; font-size: 20px;">加载失败</div>';
                }
            } catch (error) {
                ordersListDiv.innerHTML = '<div style="padding: 32px; text-align: center; color: #888; font-size: 20px;">加载失败</div>';
            }
        }

        // 获取订单状态文本
        function getOrderStatusText(status) {
            switch (status) {
                case 1: return "未支付";
                case 2: return "已支付";
                case 3: return "已过期";
                case 4: return "已取消";
                default: return "未知状态";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            auth.init();
            loadOrders();
        });
    </script>
</body>
</html> 